trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "*/*"
    exclude:
      - README.md
pr: none

resources:
  - repo: self

variables:
  dockerRegistryServiceConnection: "wayruprod-registry"
  imageRepository: "wayru/operators-web"
  containerRegistry: "wayruprod.azurecr.io"
  dockerfilePath: "Dockerfile"
  tag: "$(Build.BuildId)"
  helmChartPath: "$(Build.SourcesDirectory)/deploy/chart"
  helmReleaseName: "operators-web"
  environment: "operators-web-prod"
  kubernetesServiceConnection: "operators-web-prod"
  kubernetesClusterNamespace: "operators"

  # Agent VM image name
  vmImageName: "ubuntu-latest"

stages:
  - stage: Build
    displayName: Build stage
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
           displayName: Build image
           inputs:
             command: build
             repository: $(imageRepository)
             dockerfile: $(dockerfilePath)
             containerRegistry: $(dockerRegistryServiceConnection)
             buildContext: "$(Build.SourcesDirectory)"
             arguments: |
               --secret id=stripe_key,env=STRIPE_SECRET_KEY
             tags: |
               $(tag)
               latest
           env:
             STRIPE_SECRET_KEY: $(STRIPE_SECRET_KEY)
          - task: Docker@2
            displayName: Push image
            inputs:
              command: push
              repository: $(imageRepository)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

          - task: PublishPipelineArtifact@1
            displayName: "Publish Helm Chart"
            inputs:
              targetPath: $(helmChartPath)
              artifact: "chart"
              publishLocation: "pipeline"

  - stage: Deploy
    displayName: Deploy to Kubernetes
    dependsOn: Build
    jobs:
      - deployment: Deploy
        displayName: Deploy with Helm
        pool:
          vmImage: $(vmImageName)
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: "Download Helm Chart"
                  inputs:
                    artifactName: "chart"
                    targetPath: "$(Pipeline.Workspace)/chart"

                - task: HelmDeploy@0
                  displayName: "Deploy Operators Web with Helm"
                  inputs:
                    connectionType: "Kubernetes Service Connection"
                    kubernetesServiceConnection: $(kubernetesServiceConnection)
                    namespace: $(kubernetesClusterNamespace)
                    command: "upgrade"
                    chartType: "FilePath"
                    chartPath: $(Pipeline.Workspace)/chart
                    releaseName: $(helmReleaseName)
                    install: true
                    waitForExecution: true
                    arguments: "--timeout 5m0s"
                    valueFile: "$(Pipeline.Workspace)/chart/values-prod.yaml"
                    overrideValues: |
                      imageTag=$(tag)

                - task: Kubernetes@1
                  displayName: "Validate Deployment"
                  inputs:
                    connectionType: "Kubernetes Service Connection"
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(kubernetesClusterNamespace)
                    command: "get"
                    arguments: "pods,svc -l app=$(helmReleaseName) -o wide"

                - task: Kubernetes@1
                  displayName: "Check Deployment Status"
                  inputs:
                    connectionType: "Kubernetes Service Connection"
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(kubernetesClusterNamespace)
                    command: "rollout"
                    arguments: "status deployment/$(helmReleaseName) --timeout=120s"
